{% load custom_filters %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Detalle de Sesión #{{ sesion.id }}</title>
    <style>
        @page { size: A4; margin: 1.5cm; }
        body { font-family: Arial; font-size: 12px; line-height: 1.4; }
        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }
        .header h1 { margin: 0; font-size: 18px; }
        .header .subtitle { font-size: 14px; color: #666; }
        .info-section { margin-bottom: 15px; }
        .info-section .info-item { display: inline-block; margin-right: 30px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th { background-color: #f2f2f2; text-align: left; padding: 8px; border: 1px solid #ddd; font-weight: bold; }
        td { padding: 6px 8px; border: 1px solid #ddd; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .positive { color: #28a745; }
        .negative { color: #dc3545; }
        .summary { margin-top: 20px; padding: 10px; background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; }
        .footer { margin-top: 30px; font-size: 10px; text-align: center; color: #666; border-top: 1px solid #ddd; padding-top: 5px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Reporte Detallado de Sesión de Caja</h1>
        <div class="subtitle">{{ empresa_nombre|default:"Mi Empresa" }}</div>
    </div>

    <div class="info-section">
        <div class="info-item"><strong>Sesión ID:</strong> #{{ sesion.id }}</div>
        <div class="info-item"><strong>Caja:</strong> {{ sesion.caja.nombre }}</div>
        <div class="info-item"><strong>Responsable:</strong> {{ sesion.responsable.usuario.get_full_name }}</div>
    </div>

    <div class="info-section">
        <div class="info-item"><strong>Apertura:</strong> {{ sesion.fecha_apertura|date:"d/m/Y H:i" }}</div>
        <div class="info-item"><strong>Cierre:</strong> {{ sesion.fecha_cierre|date:"d/m/Y H:i" }}</div>
        <div class="info-item"><strong>Duración:</strong> {{ duracion }}</div>
    </div>

    <h2>Resumen Financiero</h2>
    <table>
        <tr>
            <th>Concepto</th>
            <th class="text-right">Monto</th>
        </tr>
        <tr>
            <td>Saldo Inicial</td>
            <td class="text-right">${{ sesion.saldo_inicial|floatformat:2 }}</td>
        </tr>
        <tr>
            <td>Total Ingresos</td>
            <td class="text-right">${{ total_ingresos|floatformat:2 }}</td>
        </tr>
        <tr>
            <td>Total Egresos</td>
            <td class="text-right">${{ total_egresos|floatformat:2 }}</td>
        </tr>
        <tr>
            <td>Saldo Teórico</td>
            <td class="text-right">${{ sesion.saldo_teorico|floatformat:2 }}</td>
        </tr>
        <tr>
            <td>Saldo Final (Real)</td>
            <td class="text-right">${{ sesion.saldo_final|floatformat:2 }}</td>
        </tr>
        <tr>
            <td>Diferencia</td>
            <td class="text-right {% if sesion.diferencia >= 0 %}positive{% else %}negative{% endif %}">
                ${{ sesion.diferencia|floatformat:2|default:"0.00" }}
            </td>
        </tr>
    </table>

    <h2>Movimientos Registrados ({{ sesion.movimientos.count }})</h2>
    <table>
        <thead>
            <tr>
                <th>Fecha/Hora</th>
                <th>Tipo</th>
                <th class="text-right">Monto</th>
                <th>Descripción</th>
                <th>Comprobante</th>
                <th>Responsable</th>
            </tr>
        </thead>
        <tbody>
            {% for movimiento in sesion.movimientos.all %}
            <tr>
                <td>{{ movimiento.fecha|date:"d/m/Y H:i" }}</td>
                <td>{{ movimiento.get_tipo_display }}</td>
                <td class="text-right {% if movimiento.tipo == 'INGRESO' %}positive{% else %}negative{% endif %}">
                    ${{ movimiento.monto|floatformat:2 }}
                </td>
                <td>{{ movimiento.descripcion }}</td>
                <td>{{ movimiento.comprobante|default:"-" }}</td>
                <td>{{ movimiento.responsable.usuario.get_short_name }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if sesion.observaciones %}
    <div class="summary">
        <h3>Observaciones:</h3>
        <p>{{ sesion.observaciones }}</p>
    </div>
    {% endif %}

    <div class="footer">
        Generado el {{ fecha_reporte|date:"d/m/Y H:i" }} por {{ usuario.get_full_name }}<br>
        {{ empresa_nombre|default:"Mi Empresa" }} - {{ empresa_direccion|default:"Dirección no especificada" }}
    </div>
</body>
</html>