{% extends 'base.html' %}
{% load filtros_paraguay %}
{% load form_filters %}

{% block content %}
<div class="max-w-3xl mx-auto bg-white shadow-md rounded-xl p-6">
  <!-- Encabezado -->
  <div class="mb-6 border-b pb-4">
    <h2 class="text-2xl font-bold text-gray-800">{{ titulo }}</h2>
    <p class="text-sm text-gray-600">Complete los datos para finalizar la venta</p>
    
    {% if messages %}
      <div class="mt-4 space-y-2">
        {% for message in messages %}
          <div class="p-3 rounded {% if message.tags == 'error' %}bg-red-100 text-red-800{% else %}bg-blue-100 text-blue-800{% endif %}">
            <i class="fas {% if message.tags == 'error' %}fa-exclamation-circle{% else %}fa-info-circle{% endif %} mr-2"></i>
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <!-- Resumen de Venta -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <div>
      <h4 class="text-lg font-semibold text-gray-700 mb-2">Datos de la Venta</h4>
      <div class="space-y-2">
        <p><strong>Cliente:</strong> {{ venta.cliente|default:"Consumidor Final" }}</p>
        <p><strong>Documento:</strong> {{ venta.cliente.tipo_documento|default:"-" }} {{ venta.cliente.numero_documento|default:"-" }}</p>
        <p><strong>Fecha:</strong> {{ venta.fecha|date:"d/m/Y H:i" }}</p>
      </div>
    </div>
    
    <div>
      <h4 class="text-lg font-semibold text-gray-700 mb-2">Totales</h4>
      <div class="space-y-2">
        <p><strong>Subtotal:</strong> Gs. {{ venta.subtotal|pyg_intcomma }}</p>
        <p><strong>IVA 10%:</strong> Gs. {{ venta.iva10|pyg_intcomma }}</p>
        <p><strong>IVA 5%:</strong> Gs. {{ venta.iva5|pyg_intcomma }}</p>
        <p class="font-bold text-lg"><strong>Total:</strong> Gs. {{ venta.total|pyg_intcomma }}</p>
      </div>
    </div>
  </div>

  <!-- Formulario -->
  <form method="post" class="space-y-6" id="finalizarVentaForm">
    {% csrf_token %}
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Tipo de Documento -->
      <div>
        <label for="{{ form.tipo_documento.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
          Tipo Documento *
        </label>
        {{ form.tipo_documento|add_attrs:"class=w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500" }}
        {% if form.tipo_documento.errors %}
          <p class="text-sm text-red-600 mt-1">{{ form.tipo_documento.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- Condición -->
      <div>
        <label for="{{ form.condicion.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
          Condición *
        </label>
        {{ form.condicion|add_attrs:"class=w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500" }}
        {% if form.condicion.errors %}
          <p class="text-sm text-red-600 mt-1">{{ form.condicion.errors.0 }}</p>
        {% endif %}
      </div>
      
      <!-- Campos para crédito (condicionales) -->
      <div id="creditoFields" style="display: none;" class="md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
          <label for="{{ form.entrega_inicial.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
            {{ form.entrega_inicial.label }}
          </label>
          {{ form.entrega_inicial|add_attrs:"class=w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500" }}
          {% if form.entrega_inicial.errors %}
            <p class="text-sm text-red-600 mt-1">{{ form.entrega_inicial.errors.0 }}</p>
          {% endif %}
          <p class="text-xs text-gray-500 mt-1">Monto inicial al momento de la venta</p>
        </div>
        
        <div>
          <label for="{{ form.dia_vencimiento.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
            {{ form.dia_vencimiento.label }}
          </label>
          {{ form.dia_vencimiento|add_attrs:"class=w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500" }}
          {% if form.dia_vencimiento.errors %}
            <p class="text-sm text-red-600 mt-1">{{ form.dia_vencimiento.errors.0 }}</p>
          {% endif %}
          <p class="text-xs text-gray-500 mt-1">Ej: 5 (vencerá día 5 de cada mes)</p>
        </div>
        
        <div>
          <label for="{{ form.fecha_primer_vencimiento.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
            {{ form.fecha_primer_vencimiento.label }}
          </label>
          {{ form.fecha_primer_vencimiento|add_attrs:"class=w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500" }}
          {% if form.fecha_primer_vencimiento.errors %}
            <p class="text-sm text-red-600 mt-1">{{ form.fecha_primer_vencimiento.errors.0 }}</p>
          {% endif %}
        </div>

        <div>
          <label for="{{ form.numero_cuotas.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
            {{ form.numero_cuotas.label }}
          </label>
          {{ form.numero_cuotas|add_attrs:"class=w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500" }}
          {% if form.numero_cuotas.errors %}
            <p class="text-sm text-red-600 mt-1">{{ form.numero_cuotas.errors.0 }}</p>
          {% endif %}
          <p class="text-xs text-gray-500 mt-1">Número de cuotas (1-36)</p>
        </div>
        
        <div>
          <label for="{{ form.monto_cuota.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
            {{ form.monto_cuota.label }}
          </label>
          {{ form.monto_cuota|add_attrs:"class=w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500" }}
          {% if form.monto_cuota.errors %}
            <p class="text-sm text-red-600 mt-1">{{ form.monto_cuota.errors.0 }}</p>
          {% endif %}
          <p class="text-xs text-gray-500 mt-1">Monto por cada cuota</p>
        </div>
      </div>
      
      <!-- Timbrado (condicional) -->
      <div id="timbradoContainer" class="{% if venta.tipo_documento not in 'F,BV' %}hidden{% endif %}">
        <label for="{{ form.timbrado.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
          Timbrado {% if venta.tipo_documento in 'F,BV' %}*{% endif %}
        </label>
        {{ form.timbrado|add_attrs:"class=w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500" }}
        {% if form.timbrado.errors %}
          <p class="text-sm text-red-600 mt-1">{{ form.timbrado.errors.0 }}</p>
        {% endif %}
      </div>
      
      <!-- Tipo de Pago -->
      <div>
        <label for="{{ form.tipo_pago.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
          {{ form.tipo_pago.label }} *
        </label>
        {{ form.tipo_pago|add_attrs:"class=w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500" }}
        {% if form.tipo_pago.errors %}
          <p class="text-sm text-red-600 mt-1">{{ form.tipo_pago.errors.0 }}</p>
        {% endif %}
      </div>
      
      <!-- Caja -->
      <div>
        <label for="{{ form.caja.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
          {{ form.caja.label }} *
        </label>
        {{ form.caja|add_attrs:"class=w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500" }}
        {% if form.caja.errors %}
          <p class="text-sm text-red-600 mt-1">{{ form.caja.errors.0 }}</p>
        {% endif %}
      </div>
      
      <!-- Almacén para servicios (condicional) -->
      <div id="almacenServiciosContainer" class="{% if not venta.tiene_servicios_con_inventario %}hidden{% endif %}">
        <label for="{{ form.almacen_servicios.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
          {{ form.almacen_servicios.label }}
        </label>
        {{ form.almacen_servicios|add_attrs:"class=w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500" }}
        {% if form.almacen_servicios.errors %}
          <p class="text-sm text-red-600 mt-1">{{ form.almacen_servicios.errors.0 }}</p>
        {% endif %}
        <p class="text-xs text-gray-500 mt-1">{{ form.almacen_servicios.help_text }}</p>
      </div>
    </div>

    <!-- Opción de documento electrónico -->
    {% if puede_generar_documento %}
    <div class="bg-blue-50 p-4 rounded-lg">
      <div class="flex items-start">
        <div class="flex items-center h-5">
          {{ form.generar_documento|add_attrs:"class=rounded h-4 w-4 text-blue-600 focus:ring-blue-500" }}
        </div>
        <div class="ml-3 text-sm">
          <label for="{{ form.generar_documento.id_for_label }}" class="font-medium text-gray-700">
            {{ form.generar_documento.label }}
          </label>
          <p class="text-gray-500">{{ form.generar_documento.help_text }}</p>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Detalles de la venta -->
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Descripción</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ubicación</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cantidad</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Precio Unit.</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Subtotal</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for detalle in venta.detalles.all %}
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                {% if detalle.tipo == 'PRODUCTO' %}bg-blue-100 text-blue-800
                {% else %}bg-purple-100 text-purple-800{% endif %}">
                {{ detalle.get_tipo_display }}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              {% if detalle.tipo == 'PRODUCTO' %}
                {{ detalle.producto.nombre }}
              {% else %}
                {{ detalle.servicio.nombre }}
                {% if detalle.servicio.tipo == 'COMPUESTO' %}
                  <span class="block text-xs text-gray-500">(Servicio compuesto)</span>
                {% endif %}
              {% endif %}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              {% if detalle.tipo == 'PRODUCTO' %}
                {{ detalle.almacen.nombre }}
              {% elif detalle.tipo == 'SERVICIO' and detalle.servicio.tipo == 'COMPUESTO' %}
                {{ detalle.almacen_servicio.nombre|default:"-" }}
              {% else %}
                -
              {% endif %}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">{{ detalle.cantidad }}</td>
            <td class="px-6 py-4 whitespace-nowrap">Gs. {{ detalle.precio_unitario|pyg_intcomma }}</td>
            <td class="px-6 py-4 whitespace-nowrap">Gs. {{ detalle.subtotal|pyg_intcomma }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div id="documentoPreview" class="bg-blue-50 p-4 rounded-lg mt-4 {% if not venta.tipo_documento %}hidden{% endif %}">
        <h4 class="text-lg font-semibold text-blue-800 mb-2">Número de Documento</h4>
        <div class="flex items-center">
          <span class="font-mono text-gray-700 bg-white p-2 rounded border border-gray-300">
            <span id="prefijoDocumento">
              {% if venta.punto_expedicion %}
                {{ venta.punto_expedicion.get_codigo_completo }}-
              {% else %}
                [Seleccione caja]-
              {% endif %}
            </span>
            <span id="numeroSecuencia">
              {% if venta.numero_documento %}
                {{ venta.numero_documento|slice:"7:" }}
              {% else %}
                [Número secuencial]
              {% endif %}
            </span>
          </span>
          <span class="ml-2 text-sm text-gray-500">
            (Formato: PuntoExpedición-NumeroSecuencial)
          </span>
        </div>
        <p class="text-sm text-gray-600 mt-2">
          Tipo: <span id="tipoDocumentoPreview">{{ venta.get_tipo_documento_display|default:"[Seleccione tipo]" }}</span>
        </p>
      </div>

    <!-- Botones -->
    <div class="flex justify-between items-center pt-4 border-t">
      <button type="submit"
              class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg inline-flex items-center gap-2 transition-colors duration-200">
        <i class="fas fa-check-circle"></i> Confirmar Venta
      </button>

      <a href="{% url 'ventas:editar_venta' venta.id %}"
         class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg inline-flex items-center gap-2 transition-colors duration-200">
        <i class="fas fa-edit"></i> Volver a Editar
      </a>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Función para manejar campos de crédito
    function actualizarCamposCredito() {
        const condicionSelect = document.getElementById('id_condicion');
        const creditoFields = document.getElementById('creditoFields');
        const entregaInicial = document.getElementById('id_entrega_inicial');
        const diaVencimiento = document.getElementById('id_dia_vencimiento');
        const fechaVencimiento = document.getElementById('id_fecha_primer_vencimiento');
        const numeroCuotas = document.getElementById('id_numero_cuotas');
        const montoCuota = document.getElementById('id_monto_cuota');
        
        if (condicionSelect && condicionSelect.value === '2') { // CRÉDITO
            creditoFields.style.display = 'grid';
            entregaInicial.disabled = false;
            diaVencimiento.disabled = false;
            fechaVencimiento.disabled = false;
            numeroCuotas.disabled = false;
            montoCuota.disabled = false;
            
            // Establecer fecha mínima para primer vencimiento (mañana)
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            fechaVencimiento.min = tomorrow.toISOString().split('T')[0];
            
            // Si no hay fecha establecida, poner 30 días después como sugerencia
            if (!fechaVencimiento.value) {
                const defaultDate = new Date();
                defaultDate.setDate(defaultDate.getDate() + 30);
                fechaVencimiento.value = defaultDate.toISOString().split('T')[0];
            }
            
            // Calcular cuotas iniciales
            calcularCuotas();
        } else {
            creditoFields.style.display = 'none';
            entregaInicial.disabled = true;
            diaVencimiento.disabled = true;
            fechaVencimiento.disabled = true;
            numeroCuotas.disabled = true;
            montoCuota.disabled = true;
        }
    }
    
    // Función para calcular cuotas
    function calcularCuotas() {
        const condicionSelect = document.getElementById('id_condicion');
        const entregaInicial = parseFloat(document.getElementById('id_entrega_inicial').value) || 0;
        const numeroCuotas = document.getElementById('id_numero_cuotas');
        const montoCuota = document.getElementById('id_monto_cuota');
        const totalVenta = parseFloat('{{ venta.total|escapejs }}');
        
        if (condicionSelect.value === '2') { // CRÉDITO
            const totalFinanciar = totalVenta - entregaInicial;
            
            // Si cambia el número de cuotas, calcular el monto
            numeroCuotas.addEventListener('input', function() {
                const cuotas = parseInt(this.value) || 1;
                if (cuotas > 0) {
                    montoCuota.value = (totalFinanciar / cuotas).toFixed(2);
                }
            });
            
            // Si cambia el monto, calcular el número de cuotas
            montoCuota.addEventListener('input', function() {
                const monto = parseFloat(this.value) || 0;
                if (monto > 0) {
                    numeroCuotas.value = Math.max(1, Math.ceil(totalFinanciar / monto));
                }
            });
            
            // Calcular inicialmente
            const cuotasInicial = parseInt(numeroCuotas.value) || 1;
            montoCuota.value = (totalFinanciar / cuotasInicial).toFixed(2);
        }
    }
    
    // Función para actualizar visibilidad del timbrado
    function actualizarTimbrado() {
        const tipoDocumentoSelect = document.getElementById('id_tipo_documento');
        const timbradoContainer = document.getElementById('timbradoContainer');
        const timbradoInput = document.getElementById('id_timbrado');
        
        if (tipoDocumentoSelect && ['F', 'BV'].includes(tipoDocumentoSelect.value)) {
            timbradoContainer.classList.remove('hidden');
            timbradoInput.required = true;
        } else {
            timbradoContainer.classList.add('hidden');
            timbradoInput.required = false;
        }
    }
    
    // Función para actualizar la previsualización del documento
    async function actualizarPreview() {
        const tipoDocumentoSelect = document.getElementById('id_tipo_documento');
        const cajaSelect = document.getElementById('id_caja');
        const documentoPreview = document.getElementById('documentoPreview');
        const prefijoDocumento = document.getElementById('prefijoDocumento');
        const numeroSecuencia = document.getElementById('numeroSecuencia');
        const tipoDocumentoPreview = document.getElementById('tipoDocumentoPreview');
        
        // Mostrar sección si hay tipo de documento seleccionado
        if (tipoDocumentoSelect && tipoDocumentoSelect.value) {
            documentoPreview.classList.remove('hidden');
            tipoDocumentoPreview.textContent = tipoDocumentoSelect.options[tipoDocumentoSelect.selectedIndex].text;
        } else {
            documentoPreview.classList.add('hidden');
        }
        
        // Actualizar prefijo y número si hay caja y tipo de documento seleccionados
        if (cajaSelect && cajaSelect.value && tipoDocumentoSelect && tipoDocumentoSelect.value) {
            try {
                const response = await fetch(`/caja/api/caja/${cajaSelect.value}/punto-expedicion/`);
                if (!response.ok) throw new Error('Error al obtener datos');
                
                const data = await response.json();
                prefijoDocumento.textContent = `${data.codigo}-`;
                
                // Mapeo entre tipos de documento de venta y tipos de secuencia
                const tipoSecuenciaMap = {
                    'F': 'FACTURA',
                    'T': 'TICKET'
                };
                
                // Buscar la secuencia correspondiente al tipo de documento
                const tipoSecuencia = tipoSecuenciaMap[tipoDocumentoSelect.value];
                const secuencia = data.secuencias.find(s => s.tipo_documento === tipoSecuencia);
                
                if (secuencia) {
                    // Formatear el número según el formato de la secuencia
                    const numeroFormateado = secuencia.formato
                        .replace('{sucursal}', data.codigo.split('-')[0])
                        .replace('{punto}', data.codigo.split('-')[1])
                        .replace('{numero:07d}', secuencia.siguiente_numero.toString().padStart(7, '0'));
                    
                    numeroSecuencia.textContent = numeroFormateado.split('-').pop();
                } else {
                    numeroSecuencia.textContent = '[Secuencia no configurada]';
                }
                
            } catch (error) {
                console.error(error);
                prefijoDocumento.textContent = '[Error al obtener datos]-';
                numeroSecuencia.textContent = '[Error]';
            }
        } else {
            prefijoDocumento.textContent = cajaSelect && cajaSelect.value ? '[Seleccione tipo doc.]-' : '[Seleccione caja]-';
            numeroSecuencia.textContent = '[Número secuencial]';
        }
    }
    
    // Configurar event listeners
    const condicionSelect = document.getElementById('id_condicion');
    if (condicionSelect) {
        condicionSelect.addEventListener('change', function() {
            actualizarCamposCredito();
            actualizarPreview();
        });
    }
    
    const tipoDocumentoSelect = document.getElementById('id_tipo_documento');
    if (tipoDocumentoSelect) {
        tipoDocumentoSelect.addEventListener('change', function() {
            actualizarTimbrado();
            actualizarPreview();
        });
    }
    
    const cajaSelect = document.getElementById('id_caja');
    if (cajaSelect) {
        cajaSelect.addEventListener('change', actualizarPreview);
    }
    
    document.getElementById('id_entrega_inicial').addEventListener('input', calcularCuotas);
    
    // Inicializar estado
    actualizarCamposCredito();
    actualizarTimbrado();
    actualizarPreview();
});
</script>
{% endblock %}