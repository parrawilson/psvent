{% extends 'base.html' %}
{% load static %}
{% load form_filters %}

{% block content %}
<style>
    .border-red-500 {
        border-color: #ef4444 !important;
    }
    .tipo-producto {
        display: none;
    }
    .tipo-servicio {
        display: none;
    }
    .servicio-compuesto {
        display: none;
    }
</style>

<div class="flex justify-center py-6 px-4">
  <div class="w-full max-w-6xl bg-white p-6 rounded-xl shadow-lg">
    <h2 class="text-2xl font-bold text-gray-800 mb-6">{{ titulo }}</h2>
    
    {% if messages %}
      {% for message in messages %}
        {% if message.tags == 'success' %}
          <div class="p-4 bg-green-100 border border-green-200 text-green-800 rounded mb-6">
            {{ message }}
          </div>
        {% endif %}
      {% endfor %}
    {% endif %}

    <form method="post" id="venta-form">
      {% csrf_token %}
      {{ form.non_field_errors }}
      
      <!-- Sección superior con información básica -->
      <div class="grid grid-cols-1 md:grid-cols-1 gap-6 mb-6">
        <div class="bg-gray-50 p-4 rounded-lg">
          <h3 class="text-lg font-semibold text-gray-700 mb-3">Información de la Venta</h3>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Cliente</label>
              {{ form.cliente|add_attrs:"class=w-full px-3 py-2 border rounded-lg" }}
              {{ form.cliente.errors }}
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Notas</label>
              {{ form.notas|add_attrs:"class=w-full px-3 py-2 border rounded-lg min-h-[80px]" }}
              {{ form.notas.errors }}
            </div>

            <div class="space-y-2">
              <h3 class="text-lg font-semibold text-gray-700 mb-3">Totales</h3>
              <p><span class="font-medium text-gray-700">Grav. 10%:</span> <span data-total="grav10">Gs/ 0</span></p>
              <p><span class="font-medium text-gray-700">Grav. 5%:</span> <span data-total="grav5">Gs/ 0</span></p>
              <p><span class="font-medium text-gray-700">IVA 10%:</span> <span data-total="iva10">Gs/ 0</span></p>
              <p><span class="font-medium text-gray-700">IVA 5%:</span> <span data-total="iva5">Gs/ 0</span></p>
              <p><span class="font-medium text-gray-700">Subtotal Grav. 10%:</span> <span data-total="subgrav10">Gs/ 0</span></p>
              <p><span class="font-medium text-gray-700">Subtotal Grav. 5%:</span> <span data-total="subgrav5">Gs/ 0</span></p>
              <p><span class="font-medium text-gray-700">Total:</span> <span data-total="total">Gs/ 0</span></p>
            </div>
          </div>
        </div>
      </div>

      <!-- Sección de búsqueda rápida por código -->
      <div class="mb-6 bg-blue-50 p-4 rounded-lg">
        <h3 class="text-lg font-semibold text-gray-700 mb-3">Agregar Producto/Servicio</h3>
        <div class="flex gap-4">
          <input type="text" id="codigo-busqueda" placeholder="Escanear o ingresar código/nombre" 
                 class="flex-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <button type="button" id="buscar-codigo" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">
            Buscar
          </button>
          <button type="button" id="activar-escaneo" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 22V12h6v10" />
            </svg>
            Escanear
          </button>
        </div>
        <div id="resultado-busqueda" class="mt-3 hidden"></div>
      </div>

      <!-- Sección de detalles -->
      <div class="mb-6">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Detalles</h3>
        {{ formset.management_form }}
        <div id="formset-container" class="space-y-4">
          {% for form_detalle in formset %}
            {% if form_detalle.producto.value or form_detalle.servicio.value or forloop.last and not forloop.first %}
            <div class="formset-item grid grid-cols-1 md:grid-cols-8 gap-4 border-b pb-4 relative">
              {{ form_detalle.id }}
              <div>
                {{ form_detalle.tipo.label_tag }}
                {{ form_detalle.tipo|add_attrs:"class=w-full px-3 py-2 border rounded-lg tipo-select" }}
                {{ form_detalle.tipo.errors }}
              </div>
              
              <!-- Campos para producto -->
              <div class="tipo-producto">
                {{ form_detalle.producto.label_tag }}
                {{ form_detalle.producto|add_attrs:"class=w-full px-3 py-2 border rounded-lg producto-select" }}
                {{ form_detalle.producto.errors }}
              </div>
              
              <!-- Campos para servicio -->
              <div class="tipo-servicio">
                {{ form_detalle.servicio.label_tag }}
                {{ form_detalle.servicio|add_attrs:"class=w-full px-3 py-2 border rounded-lg servicio-select" }}
                {{ form_detalle.servicio.errors }}
              </div>
              
              <div>
                {{ form_detalle.cantidad.label_tag }}
                {{ form_detalle.cantidad|add_attrs:"class=w-full px-3 py-2 border rounded-lg cantidad-input" }}
                {{ form_detalle.cantidad.errors }}
              </div>
              <div>
                {{ form_detalle.precio_unitario.label_tag }}
                {{ form_detalle.precio_unitario|add_attrs:"class=w-full px-3 py-2 border rounded-lg precio-input" }}
                {{ form_detalle.precio_unitario.errors }}
              </div>
              <div>
                {{ form_detalle.tasa_iva.label_tag }}
                {{ form_detalle.tasa_iva|add_attrs:"class=w-full px-3 py-2 border rounded-lg tasa-input" }}
                {{ form_detalle.tasa_iva.errors }}
              </div>
              
              <!-- Almacén para producto -->
              <div class="tipo-producto">
                {{ form_detalle.almacen.label_tag }}
                {{ form_detalle.almacen|add_attrs:"class=w-full px-3 py-2 border rounded-lg almacen-select" }}
                {{ form_detalle.almacen.errors }}
              </div>
              
              <!-- Almacén para servicio compuesto -->
              <div class="tipo-servicio servicio-compuesto">
                {{ form_detalle.almacen_servicio.label_tag }}
                {{ form_detalle.almacen_servicio|add_attrs:"class=w-full px-3 py-2 border rounded-lg almacen-servicio-select" }}
                {{ form_detalle.almacen_servicio.errors }}
              </div>
              
              <div class="flex items-end">
                <button type="button" class="remove-item bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-lg">
                  Eliminar
                </button>
              </div>
            </div>
            {% endif %}
          {% endfor %}
        </div>
        
        <!-- Formulario oculto como plantilla -->
        <div id="empty-form" class="hidden">
          <div class="formset-item grid grid-cols-1 md:grid-cols-8 gap-4 border-b pb-4 relative">
            {{ formset.empty_form.id }}
            <div>
              {{ formset.empty_form.tipo.label_tag }}
              {{ formset.empty_form.tipo|add_attrs:"class=w-full px-3 py-2 border rounded-lg tipo-select" }}
            </div>
            
            <div class="tipo-producto">
              {{ formset.empty_form.producto.label_tag }}
              {{ formset.empty_form.producto|add_attrs:"class=w-full px-3 py-2 border rounded-lg producto-select" }}
            </div>
            
            <div class="tipo-servicio">
              {{ formset.empty_form.servicio.label_tag }}
              {{ formset.empty_form.servicio|add_attrs:"class=w-full px-3 py-2 border rounded-lg servicio-select" }}
            </div>
            
            <div>
              {{ formset.empty_form.cantidad.label_tag }}
              {{ formset.empty_form.cantidad|add_attrs:"class=w-full px-3 py-2 border rounded-lg cantidad-input" }}
            </div>
            <div>
              {{ formset.empty_form.precio_unitario.label_tag }}
              {{ formset.empty_form.precio_unitario|add_attrs:"class=w-full px-3 py-2 border rounded-lg precio-input" }}
            </div>
            <div>
              {{ formset.empty_form.tasa_iva.label_tag }}
              {{ formset.empty_form.tasa_iva|add_attrs:"class=w-full px-3 py-2 border rounded-lg tasa-input" }}
            </div>
            
            <div class="tipo-producto">
              {{ formset.empty_form.almacen.label_tag }}
              {{ formset.empty_form.almacen|add_attrs:"class=w-full px-3 py-2 border rounded-lg almacen-select" }}
            </div>
            
            <div class="tipo-servicio servicio-compuesto">
              {{ formset.empty_form.almacen_servicio.label_tag }}
              {{ formset.empty_form.almacen_servicio|add_attrs:"class=w-full px-3 py-2 border rounded-lg almacen-servicio-select" }}
            </div>
            
            <div class="flex items-end">
              <button type="button" class="remove-item bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-lg">
                Eliminar
              </button>
            </div>
          </div>
        </div>

        <button type="button" id="add-form" class="mt-4 text-sm font-medium text-blue-600 hover:underline">
          + Agregar item manualmente
        </button>
      </div>
      
      <!-- Botones de acción -->
      <div class="flex flex-col md:flex-row gap-4">
        <a href="{% url 'ventas:lista_ventas' %}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-lg text-center">
          Cancelar
        </a>
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg">
          Guardar Venta
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal para escaneo de código -->
<div id="scanner-modal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white rounded-lg p-6 w-full max-w-md">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">Escanear Código de Barras</h3>
      <button id="close-scanner" class="text-gray-500 hover:text-gray-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div id="scanner-container" class="w-full h-64 bg-black mb-4"></div>
    <div class="flex justify-center">
      <button id="start-scanner" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg">
        Iniciar Escáner
      </button>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/quagga/dist/quagga.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const container = document.getElementById('formset-container');
  const addBtn = document.getElementById('add-form');
  const emptyFormDiv = document.getElementById('empty-form');
  const totalForms = document.getElementById('id_detalles-TOTAL_FORMS');
  const codigoBusquedaInput = document.getElementById('codigo-busqueda');
  const buscarCodigoBtn = document.getElementById('buscar-codigo');
  const activarEscaneoBtn = document.getElementById('activar-escaneo');
  const resultadoBusquedaDiv = document.getElementById('resultado-busqueda');
  const scannerModal = document.getElementById('scanner-modal');
  const closeScannerBtn = document.getElementById('close-scanner');
  const startScannerBtn = document.getElementById('start-scanner');
  const scannerContainer = document.getElementById('scanner-container');
  let scannerActive = false;

  // Función para mostrar/ocultar campos según tipo
  function actualizarCamposTipo(selectElement) {
    const formItem = selectElement.closest('.formset-item');
    const tipo = selectElement.value;
    
    // Ocultar todos los campos específicos primero
    formItem.querySelectorAll('.tipo-producto, .tipo-servicio, .servicio-compuesto').forEach(el => {
      el.style.display = 'none';
    });
    
    // Mostrar campos según el tipo seleccionado
    if (tipo === 'PRODUCTO') {
      formItem.querySelectorAll('.tipo-producto').forEach(el => {
        el.style.display = 'block';
      });
    } else if (tipo === 'SERVICIO') {
      formItem.querySelectorAll('.tipo-servicio').forEach(el => {
        el.style.display = 'block';
      });
      
      // Verificar si es un servicio compuesto
      const servicioId = formItem.querySelector('.servicio-select').value;
      if (servicioId) {
        fetch(`/almacen/api/servicios/${servicioId}/`)
          .then(response => response.json())
          .then(data => {
            if (data.tipo === 'COMPUESTO') {
              formItem.querySelector('.servicio-compuesto').style.display = 'block';
            }
          });
      }
    }
  }

  // Función para verificar si un item es válido
  function itemEsValido(item) {
    const tipo = item.querySelector('.tipo-select').value;
    const producto = item.querySelector('.producto-select')?.value;
    const servicio = item.querySelector('.servicio-select')?.value;
    const cantidad = item.querySelector('.cantidad-input').value;
    const precio = item.querySelector('.precio-input').value;
    
    if (tipo === 'PRODUCTO') {
      return producto && cantidad && precio;
    } else if (tipo === 'SERVICIO') {
      return servicio && cantidad && precio;
    }
    return false;
  }

  // Función para calcular los valores desglosados por item
  function calcularTotalesItem(item) {
    const cantidad = parseFloat(item.querySelector('.cantidad-input').value) || 0;
    const precio = parseFloat(item.querySelector('.precio-input').value) || 0;
    const tasaIva = parseInt(item.querySelector('.tasa-input').value) || 0;
    
    const subtotal = cantidad * precio;
    let gravada = 0;
    let iva = 0;
    
    if (tasaIva === 10) {
      gravada = subtotal / 1.1;
      iva = subtotal - gravada;
    } else if (tasaIva === 5) {
      gravada = subtotal / 1.05;
      iva = subtotal - gravada;
    } else {
      gravada = subtotal;
      iva = 0;
    }
    
    return {
      subtotal,
      gravada,
      iva,
      tasaIva
    };
  }

  // Función para calcular y mostrar todos los totales
  function actualizarTotales() {
    const items = container.querySelectorAll('.formset-item');
    let totalGrav10 = 0;
    let totalGrav5 = 0;
    let totalIva10 = 0;
    let totalIva5 = 0;
    let subtotalGrav10 = 0;
    let subtotalGrav5 = 0;
    let totalGeneral = 0;

    items.forEach(item => {
      if (itemEsValido(item)) {
        const { gravada, iva, tasaIva, subtotal } = calcularTotalesItem(item);
        
        if (tasaIva === 10) {
          totalGrav10 += gravada;
          totalIva10 += iva;
          subtotalGrav10 += subtotal;
        } else if (tasaIva === 5) {
          totalGrav5 += gravada;
          totalIva5 += iva;
          subtotalGrav5 += subtotal;
        }
        
        totalGeneral += subtotal;
      }
    });

    // Formatear números con separadores de miles y 2 decimales
    const formatNumber = (num) => {
      return num.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    };

    // Actualizar los totales en la interfaz
    document.querySelector('[data-total="grav10"]').textContent = `Gs/ ${formatNumber(totalGrav10)}`;
    document.querySelector('[data-total="grav5"]').textContent = `Gs/ ${formatNumber(totalGrav5)}`;
    document.querySelector('[data-total="iva10"]').textContent = `Gs/ ${formatNumber(totalIva10)}`;
    document.querySelector('[data-total="iva5"]').textContent = `Gs/ ${formatNumber(totalIva5)}`;
    document.querySelector('[data-total="subgrav10"]').textContent = `Gs/ ${formatNumber(subtotalGrav10)}`;
    document.querySelector('[data-total="subgrav5"]').textContent = `Gs/ ${formatNumber(subtotalGrav5)}`;
    document.querySelector('[data-total="total"]').textContent = `Gs/ ${formatNumber(totalGeneral)}`;
  }

  // Función para agregar un nuevo formulario
  function addNewForm(itemData = null) {
    const formNum = parseInt(totalForms.value);
    const newFormHtml = emptyFormDiv.innerHTML.replace(/__prefix__/g, formNum);
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = newFormHtml;
    const newForm = tempDiv.firstElementChild;
    container.appendChild(newForm);
    
    // Configurar eventos para el nuevo formulario
    const tipoSelect = newForm.querySelector('.tipo-select');
    tipoSelect.addEventListener('change', function(e) {
        actualizarCamposTipo(e.target);
        const formItem = e.target.closest('.formset-item');
        
        // Limpiar campos al cambiar el tipo
        if (e.target.value === 'PRODUCTO') {
            formItem.querySelector('.servicio-select').value = '';
            formItem.querySelector('.almacen-servicio-select').value = '';
        } else {
            formItem.querySelector('.producto-select').value = '';
            formItem.querySelector('.almacen-select').value = '';
        }
        
        // Limpiar precio y tasa IVA
        formItem.querySelector('.precio-input').value = '';
        formItem.querySelector('.tasa-input').value = '';
        
        actualizarTotales();
    });
    
    // Configurar evento para servicio select
    const servicioSelect = newForm.querySelector('.servicio-select');
    servicioSelect.addEventListener('change', function(e) {
        const servicioId = e.target.value;
        const formItem = e.target.closest('.formset-item');
        
        if (!servicioId) {
            formItem.querySelector('.servicio-compuesto').style.display = 'none';
            formItem.querySelector('.precio-input').value = '';
            formItem.querySelector('.tasa-input').value = '';
            actualizarTotales();
            return;
        }
        
        fetch(`/almacen/api/servicios/${servicioId}/`)
            .then(response => response.json())
            .then(data => {
                const precioInput = formItem.querySelector('.precio-input');
                const tasaInput = formItem.querySelector('.tasa-input');
                
                // Actualizar siempre el precio y la tasa IVA
                precioInput.value = data.precio;
                tasaInput.value = data.tasa_iva;
                
                // Mostrar/ocultar campo de almacén para servicio compuesto
                if (data.tipo === 'COMPUESTO') {
                    formItem.querySelector('.servicio-compuesto').style.display = 'block';
                } else {
                    formItem.querySelector('.servicio-compuesto').style.display = 'none';
                }
                
                actualizarTotales();
            });
    });
    
    // Configurar evento para producto select
    const productoSelect = newForm.querySelector('.producto-select');
    productoSelect.addEventListener('change', function(e) {
        const productoId = e.target.value;
        const formItem = e.target.closest('.formset-item');
        
        if (!productoId) {
            formItem.querySelector('.precio-input').value = '';
            formItem.querySelector('.tasa-input').value = '';
            actualizarTotales();
            return;
        }
        
        fetch(`/almacen/api/productos/${productoId}/`)
            .then(response => response.json())
            .then(data => {
                const precioInput = formItem.querySelector('.precio-input');
                const tasaInput = formItem.querySelector('.tasa-input');
                
                // Actualizar siempre el precio y la tasa IVA
                precioInput.value = data.precio_minorista;
                tasaInput.value = data.tasa_iva;
                actualizarTotales();
            });
    });
    
    // Si hay datos del item, llenar el formulario
    if (itemData) {
        if (itemData.tipo === 'producto') {
            tipoSelect.value = 'PRODUCTO';
            productoSelect.value = itemData.id;
            newForm.querySelector('.precio-input').value = itemData.precio_minorista;
            newForm.querySelector('.tasa-input').value = itemData.tasa_iva;
        } else if (itemData.tipo === 'servicio') {
            tipoSelect.value = 'SERVICIO';
            servicioSelect.value = itemData.id;
            newForm.querySelector('.precio-input').value = itemData.precio;
            newForm.querySelector('.tasa-input').value = itemData.tasa_iva;
            
            // Mostrar almacén si es servicio compuesto
            if (itemData.tipo_servicio === 'COMPUESTO') {
                newForm.querySelector('.servicio-compuesto').style.display = 'block';
            }
        }
        
        newForm.querySelector('.cantidad-input').value = 1;
        newForm.querySelector('.cantidad-input').focus();
        
        // Actualizar campos según tipo
        actualizarCamposTipo(tipoSelect);
    }
    
    totalForms.value = formNum + 1;
    
    // Disparar evento personalizado
    const event = new Event('itemAdded');
    document.dispatchEvent(event);
    
    return newForm;
  }

  // Función para buscar producto o servicio por código o nombre
  async function buscarItemPorCodigo(codigo) {
      try {
          const response = await fetch(`/almacen/api/buscar/?q=${encodeURIComponent(codigo)}`);
          if (!response.ok) throw new Error('Item no encontrado');
          
          const data = await response.json();
          
          // Verificar si encontramos productos o servicios
          if (data.productos && data.productos.length > 0) {
              return {
                  tipo: 'producto',
                  id: data.productos[0].id,
                  codigo: data.productos[0].codigo,
                  nombre: data.productos[0].nombre,
                  precio_minorista: data.productos[0].precio_minorista,
                  tasa_iva: data.productos[0].tasa_iva
              };
          } else if (data.servicios && data.servicios.length > 0) {
              return {
                  tipo: 'servicio',
                  id: data.servicios[0].id,
                  codigo: data.servicios[0].codigo,
                  nombre: data.servicios[0].nombre,
                  precio: data.servicios[0].precio,
                  tasa_iva: data.servicios[0].tasa_iva,
                  tipo_servicio: data.servicios[0].tipo
              };
          } else {
              throw new Error('No se encontraron productos ni servicios');
          }
      } catch (error) {
          console.error('Error al buscar item:', error);
          resultadoBusquedaDiv.innerHTML = `
              <div class="p-3 bg-red-100 text-red-800 rounded">
                  ${error.message || 'Producto/servicio no encontrado. Verifique el código/nombre e intente nuevamente.'}
              </div>
          `;
          resultadoBusquedaDiv.classList.remove('hidden');
          return null;
      }
  }
  
  // Función para validar el formulario antes de enviar
  function validarFormularioVenta(event) {
    // Primero eliminar formularios vacíos
    const formItems = container.querySelectorAll('.formset-item');
    let itemsEliminados = 0;
    
    formItems.forEach(item => {
      const tipoSelect = item.querySelector('.tipo-select');
      const productoSelect = item.querySelector('.producto-select');
      const servicioSelect = item.querySelector('.servicio-select');
      const cantidadInput = item.querySelector('.cantidad-input');
      const precioInput = item.querySelector('.precio-input');
      
      // Si todos los campos están vacíos, eliminar el formulario
      if (!tipoSelect.value && !productoSelect?.value && !servicioSelect?.value && 
          !cantidadInput.value && !precioInput.value) {
        item.remove();
        itemsEliminados++;
      }
    });
    
    // Actualizar el contador de formularios
    const formsRestantes = container.querySelectorAll('.formset-item');
    totalForms.value = formsRestantes.length;

    // Validar que haya al menos un item válido
    let itemsValidos = 0;
    formItems.forEach(item => {
      if (itemEsValido(item)) {
        itemsValidos++;
      }
    });
    
    if (itemsValidos === 0) {
      event.preventDefault();
      alert('Debe agregar al menos un producto o servicio válido');
      return false;
    }
    
    return true;
  }

  // Configurar eventos para los formularios existentes
  container.querySelectorAll('.tipo-select').forEach(select => {
    select.addEventListener('change', function(e) {
        actualizarCamposTipo(e.target);
        const formItem = e.target.closest('.formset-item');
        
        // Limpiar campos al cambiar el tipo
        if (e.target.value === 'PRODUCTO') {
            formItem.querySelector('.servicio-select').value = '';
            formItem.querySelector('.almacen-servicio-select').value = '';
        } else {
            formItem.querySelector('.producto-select').value = '';
            formItem.querySelector('.almacen-select').value = '';
        }
        
        // Limpiar precio y tasa IVA
        formItem.querySelector('.precio-input').value = '';
        formItem.querySelector('.tasa-input').value = '';
        
        actualizarTotales();
    });
  });

  container.querySelectorAll('.servicio-select').forEach(select => {
    select.addEventListener('change', function(e) {
        const servicioId = e.target.value;
        const formItem = e.target.closest('.formset-item');
        
        if (!servicioId) {
            formItem.querySelector('.servicio-compuesto').style.display = 'none';
            formItem.querySelector('.precio-input').value = '';
            formItem.querySelector('.tasa-input').value = '';
            actualizarTotales();
            return;
        }
        
        fetch(`/almacen/api/servicios/${servicioId}/`)
            .then(response => response.json())
            .then(data => {
                const precioInput = formItem.querySelector('.precio-input');
                const tasaInput = formItem.querySelector('.tasa-input');
                
                // Actualizar siempre el precio y la tasa IVA
                precioInput.value = data.precio;
                tasaInput.value = data.tasa_iva;
                
                // Mostrar/ocultar campo de almacén para servicio compuesto
                if (data.tipo === 'COMPUESTO') {
                    formItem.querySelector('.servicio-compuesto').style.display = 'block';
                } else {
                    formItem.querySelector('.servicio-compuesto').style.display = 'none';
                }
                
                actualizarTotales();
            });
    });
  });

  container.querySelectorAll('.producto-select').forEach(select => {
    select.addEventListener('change', function(e) {
        const productoId = e.target.value;
        const formItem = e.target.closest('.formset-item');
        
        if (!productoId) {
            formItem.querySelector('.precio-input').value = '';
            formItem.querySelector('.tasa-input').value = '';
            actualizarTotales();
            return;
        }
        
        fetch(`/almacen/api/productos/${productoId}/`)
            .then(response => response.json())
            .then(data => {
                const precioInput = formItem.querySelector('.precio-input');
                const tasaInput = formItem.querySelector('.tasa-input');
                
                // Actualizar siempre el precio y la tasa IVA
                precioInput.value = data.precio_minorista;
                tasaInput.value = data.tasa_iva;
                actualizarTotales();
            });
    });
  });

  // Configurar eventos para eliminar items
  container.addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-item')) {
      e.preventDefault();
      const formItem = e.target.closest('.formset-item');
      formItem.remove();
      
      // Actualizar contador de formularios
      const formsRestantes = container.querySelectorAll('.formset-item');
      totalForms.value = formsRestantes.length;
      
      actualizarTotales();
    }
  });

  // Configurar eventos para actualizar totales cuando cambian los valores
  container.addEventListener('change', function(e) {
    if (e.target.classList.contains('cantidad-input') || 
        e.target.classList.contains('precio-input') || 
        e.target.classList.contains('tasa-input')) {
      actualizarTotales();
    }
  });

  // Configurar evento para agregar nuevo formulario
  addBtn.addEventListener('click', function(e) {
    e.preventDefault();
    addNewForm();
  });

  // Configurar evento para buscar por código
  buscarCodigoBtn.addEventListener('click', async function(e) {
    e.preventDefault();
    const codigo = codigoBusquedaInput.value.trim();
    if (!codigo) return;
    
    const item = await buscarItemPorCodigo(codigo);
    if (item) {
      addNewForm(item);
      codigoBusquedaInput.value = '';
      resultadoBusquedaDiv.classList.add('hidden');
    }
  });

  // Permitir buscar con Enter
  codigoBusquedaInput.addEventListener('keypress', async function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      buscarCodigoBtn.click();
    }
  });

  // Configurar escáner de código de barras
  activarEscaneoBtn.addEventListener('click', function(e) {
    e.preventDefault();
    scannerModal.classList.remove('hidden');
  });

  closeScannerBtn.addEventListener('click', function(e) {
    e.preventDefault();
    scannerModal.classList.add('hidden');
    if (scannerActive) {
      Quagga.stop();
      scannerActive = false;
    }
  });

  startScannerBtn.addEventListener('click', function() {
    if (scannerActive) return;
    
    Quagga.init({
      inputStream: {
        name: "Live",
        type: "LiveStream",
        target: scannerContainer,
        constraints: {
          width: 480,
          height: 320,
          facingMode: "environment"
        },
      },
      decoder: {
        readers: ["ean_reader", "ean_8_reader", "code_128_reader", "code_39_reader", "code_39_vin_reader", "codabar_reader", "upc_reader", "upc_e_reader"]
      },
    }, function(err) {
      if (err) {
        console.error(err);
        return;
      }
      scannerActive = true;
      Quagga.start();
    });

    Quagga.onDetected(async function(result) {
      const code = result.codeResult.code;
      Quagga.stop();
      scannerActive = false;
      scannerModal.classList.add('hidden');
      
      const item = await buscarItemPorCodigo(code);
      if (item) {
        addNewForm(item);
      }
    });
  });

  // Configurar validación del formulario principal
  document.getElementById('venta-form').addEventListener('submit', validarFormularioVenta);

  // Inicializar campos según tipo para los formularios existentes
  container.querySelectorAll('.formset-item').forEach(item => {
    const tipoSelect = item.querySelector('.tipo-select');
    if (tipoSelect.value) {
      actualizarCamposTipo(tipoSelect);
    }
  });

  // Calcular totales iniciales
  actualizarTotales();
});
</script>
{% endblock %}