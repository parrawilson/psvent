{% extends 'base.html' %}
{% block content %}
{% load static %}
<div class="flex justify-center py-6 px-4">
  <div class="w-full max-w-5xl bg-white p-6 rounded-xl shadow-lg">

    <!-- Encabezado -->
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-gray-800">{{ titulo }}</h1>
      <a href="{% url 'ventas:crear_timbrado' %}" class="inline-flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
        <i class="fas fa-plus mr-2"></i> Nuevo Timbrado
      </a>
    </div>

    <!-- Tabla -->
    <div class="overflow-x-auto">
      <table class="w-full table-auto border border-gray-300 text-sm text-left">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-4 py-2 border-b">Número</th>
            <th class="px-4 py-2 border-b">Tipo Emisión</th>
            <th class="px-4 py-2 border-b">Fecha Inicio</th>
            <th class="px-4 py-2 border-b">Fecha Fin</th>
            <th class="px-4 py-2 border-b">Estado</th>
            <th class="px-4 py-2 border-b text-center">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for timbrado in timbrados %}
          <tr id="timbrado-{{ timbrado.id }}" class="hover:bg-gray-50">
            <td class="px-4 py-2 border-b">{{ timbrado.numero }}</td>
            <td class="px-4 py-2 border-b">{{ timbrado.get_tipo_emision_display }}</td>
            <td class="px-4 py-2 border-b">{{ timbrado.fecha_inicio|date:"d/m/Y" }}</td>
            <td class="px-4 py-2 border-b">{{ timbrado.fecha_fin|date:"d/m/Y" }}</td>
            <td class="px-4 py-2 border-b">
              <span class="inline-block px-2 py-1 text-xs font-semibold rounded 
              {% if timbrado.estado == 'ACTIVO' %} bg-green-100 text-green-800 
              {% else %} bg-red-100 text-red-800 {% endif %}">
                {{ timbrado.get_estado_display }}
              </span>
            </td>
            <td class="px-4 py-2 border-b text-center">
              <a href="{% url 'ventas:editar_timbrado' timbrado.id %}" 
                 class="inline-flex items-center px-2 py-1 text-yellow-700 bg-yellow-100 hover:bg-yellow-200 rounded transition">
                <i class="fas fa-edit"></i>
              </a>
              <button class="inline-flex items-center px-2 py-1 ml-2 text-red-700 bg-red-100 hover:bg-red-200 rounded transition eliminar-btn"
                      data-id="{{ timbrado.id }}"
                      data-url="{% url 'ventas:eliminar_timbrado' timbrado.id %}">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" class="px-4 py-6 text-center text-gray-500">No hay timbrados registrados</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const csrfToken = '{{ csrf_token }}';

    document.querySelectorAll('.eliminar-btn').forEach(button => {
      button.addEventListener('click', function () {
        const url = this.dataset.url;
        const rowId = this.dataset.id;

        Swal.fire({
          title: '¿Eliminar timbrado?',
          text: "Esta acción no se puede deshacer.",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Sí, eliminar',
          cancelButtonText: 'Cancelar'
        }).then((result) => {
          if (result.isConfirmed) {
            fetch(url, {
              method: 'POST',
              headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
              }
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                document.getElementById(`timbrado-${rowId}`).remove();
                Swal.fire('Eliminado!', 'El timbrado fue eliminado.', 'success');
              } else {
                Swal.fire('Error', data.message || 'No se pudo eliminar.', 'error');
              }
            })
            .catch(() => {
              Swal.fire('Error', 'Ocurrió un error al eliminar.', 'error');
            });
          }
        });
      });
    });
  });
</script>

{% endblock %}






