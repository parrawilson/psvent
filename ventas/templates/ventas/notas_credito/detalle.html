{% extends 'base.html' %}
{% load filtros_paraguay %}

{% block content %}
<div class="max-w-5xl mx-auto bg-white shadow-md rounded-lg overflow-hidden">
  <!-- Encabezado -->
  <div class="bg-blue-600 text-white px-6 py-4">
    <div class="flex justify-between items-center">
      <div>
        <h1 class="text-2xl font-bold">Nota de Crédito #{{ nota_credito.numero }}</h1>
        <p class="text-blue-100">
          <span class="font-semibold">Estado:</span>
          <span class="inline-block px-2 py-1 rounded-full text-xs font-semibold 
            {% if nota_credito.estado == 'FINALIZADA' %}bg-green-500
            {% elif nota_credito.estado == 'CANCELADA' %}bg-red-500
            {% else %}bg-gray-500{% endif %} ml-2">
            {{ nota_credito.get_estado_display }}
          </span>
        </p>
      </div>
      <div class="text-right">
        <p class="text-xl font-bold">Gs. {{ nota_credito.total|pyg_intcomma }}</p>
        <p class="text-blue-100">{{ nota_credito.fecha|date:"d/m/Y H:i" }}</p>
      </div>
    </div>
  </div>

  <!-- Información principal -->
  <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 border-b">
    <div>
      <h2 class="text-lg font-semibold text-gray-700 mb-2">Información de la Venta</h2>
      <div class="space-y-2">
        <p><strong>Número:</strong> 
          <a href="{% url 'ventas:detalle_venta' nota_credito.venta.id %}" class="text-blue-600 hover:underline">
            {{ nota_credito.venta.numero }}
          </a>
        </p>
        <p><strong>Cliente:</strong> {{ nota_credito.venta.cliente|default:"Consumidor Final" }}</p>
        <p><strong>Fecha Venta:</strong> {{ nota_credito.venta.fecha|date:"d/m/Y H:i" }}</p>
        <p><strong>Total Venta:</strong> Gs. {{ nota_credito.venta.total|pyg_intcomma }}</p>
      </div>
    </div>

    <div>
      <h2 class="text-lg font-semibold text-gray-700 mb-2">Información de la Nota</h2>
      <div class="space-y-2">
        <p><strong>Tipo:</strong> {{ nota_credito.get_tipo_display }}</p>
        <p><strong>Caja:</strong> {{ nota_credito.caja.nombre|default:"No especificada" }}</p>
        <p><strong>Timbrado:</strong> {{ nota_credito.timbrado.numero|default:"No aplica" }}</p>
        <p><strong>Documento:</strong> {{ nota_credito.formato_numero_documento|default:"No generado" }}</p>
      </div>
    </div>
  </div>

  <!-- Detalles -->
  <div class="p-6">
    <h2 class="text-lg font-semibold text-gray-700 mb-4">Detalles de la Nota</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Producto/Servicio</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cantidad Devuelta</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Precio Unitario</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Subtotal</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for detalle in nota_credito.detalles.all %}
          <tr>
            <td class="px-6 py-4 whitespace-nowrap">
              {% if detalle.detalle_venta.producto %}
                {{ detalle.detalle_venta.producto.nombre }}
              {% else %}
                {{ detalle.detalle_venta.servicio.nombre }}
              {% endif %}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">{{ detalle.cantidad }}</td>
            <td class="px-6 py-4 whitespace-nowrap">Gs. {{ detalle.precio_unitario|pyg_intcomma }}</td>
            <td class="px-6 py-4 whitespace-nowrap">Gs. {{ detalle.subtotal|pyg_intcomma }}</td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot class="bg-gray-50">
          <tr>
            <td colspan="3" class="px-6 py-4 text-right font-bold">Total:</td>
            <td class="px-6 py-4 font-bold">Gs. {{ nota_credito.total|pyg_intcomma }}</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- Información adicional -->
  <div class="p-6 bg-gray-50">
    <h2 class="text-lg font-semibold text-gray-700 mb-2">Información Adicional</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <h3 class="font-medium text-gray-700 mb-1">Motivo</h3>
        <p class="text-gray-600 bg-white p-3 rounded border">{{ nota_credito.motivo }}</p>
      </div>
      <div>
        <h3 class="font-medium text-gray-700 mb-1">Registrado por</h3>
        <p class="text-gray-600">{{ nota_credito.creado_por.usuario.get_full_name }}</p>
        
        {% if nota_credito.notas %}
        <h3 class="font-medium text-gray-700 mt-3 mb-1">Notas</h3>
        <p class="text-gray-600 bg-white p-3 rounded border whitespace-pre-line">{{ nota_credito.notas }}</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Acciones -->
  <div class="px-6 py-4 bg-gray-100 border-t flex justify-between">
    <div>
      <a href="{% url 'ventas:lista_notas_credito' %}" 
         class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded inline-flex items-center">
        <i class="fas fa-arrow-left mr-2"></i> Volver al listado
      </a>
    </div>
    
    <div class="space-x-2">
      {% if nota_credito.estado == 'FINALIZADA' and perms.ventas.cancelar_notacredito %}
      <form method="post" action="{% url 'ventas:cancelar_nota_credito' nota_credito.id %}" class="inline">
        {% csrf_token %}
        <button type="submit" 
                class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded inline-flex items-center"
                onclick="return confirm('¿Está seguro que desea cancelar esta nota de crédito?')">
          <i class="fas fa-ban mr-2"></i> Cancelar Nota
        </button>
      </form>
      {% endif %}
      
      {% if nota_credito.estado == 'FINALIZADA' %}
      <a href="{% url 'ventas:imprimir_nota_credito' nota_credito.id %}" 
         class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded inline-flex items-center">
        <i class="fas fa-print mr-2"></i> Imprimir
      </a>
      {% endif %}
    </div>
  </div>
</div>

<!-- Modal para cancelación (opcional) -->
<div id="cancel-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
  <div class="bg-white rounded-lg p-6 max-w-md w-full">
    <h3 class="text-lg font-bold mb-4">Confirmar Cancelación</h3>
    <p class="mb-4">¿Está seguro que desea cancelar esta nota de crédito?</p>
    <form method="post" action="{% url 'ventas:cancelar_nota_credito' nota_credito.id %}">
      {% csrf_token %}
      <div class="mb-4">
        <label for="motivo-cancelacion" class="block text-sm font-medium text-gray-700">Motivo de cancelación</label>
        <textarea id="motivo-cancelacion" name="motivo" rows="3" 
                  class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm" required></textarea>
      </div>
      <div class="flex justify-end space-x-3">
        <button type="button" onclick="document.getElementById('cancel-modal').classList.add('hidden')"
                class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
          Cancelar
        </button>
        <button type="submit" 
                class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
          Confirmar Cancelación
        </button>
      </div>
    </form>
  </div>
</div>

<script>
// Función para mostrar el modal de cancelación
function showCancelModal() {
  document.getElementById('cancel-modal').classList.remove('hidden');
}
</script>
{% endblock %}